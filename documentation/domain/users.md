# Users

Users represent accounts in Morning Deck, with associated subscriptions, authentication, and role-based access control.

## Overview

The user system handles:
- User registration and authentication
- Email verification (optional)
- Subscription and credit management
- Role-based access (USER vs ADMIN)
- Invite codes for closed beta access

## Data Model

### User Entity

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/model/User.java`

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key |
| `username` | String | Unique username for login |
| `name` | String | Display name |
| `email` | String | Unique email address |
| `password` | String | BCrypt-hashed password |
| `avatarUrl` | String | Profile avatar URL (optional) |
| `language` | Language | User's preferred language |
| `role` | Role | USER or ADMIN |
| `enabled` | boolean | Account enabled status |
| `emailVerified` | boolean | Email verification status |
| `subscription` | Subscription | One-to-one subscription |
| `inviteCode` | InviteCode | Invite code used (if any) |

### Subscription Entity

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/model/Subscription.java`

| Field | Type | Description |
|-------|------|-------------|
| `id` | UUID | Primary key |
| `plan` | SubscriptionPlan | FREE, PRO, or BUSINESS |
| `autoRenew` | boolean | Auto-renew credits monthly |
| `creditsBalance` | Integer | Current available credits |
| `monthlyCredits` | Integer | Credits allocated per month |
| `nextRenewalDate` | Instant | When credits reset |

### Subscription Plans

| Plan | Monthly Credits |
|------|-----------------|
| FREE | 1,000 |
| PRO | 10,000 |
| BUSINESS | 50,000 |

Credits are set from the plan on subscription creation (`@PrePersist`).

### Roles

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/model/Role.java`

| Role | Description |
|------|-------------|
| `USER` | Standard user (default) |
| `ADMIN` | Admin access to `/admin/**` endpoints |

## Registration Flow

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/service/AuthenticationService.java`

### Standard Registration

```
POST /auth/register
{
  "username": "john",
  "name": "John Doe",
  "email": "john@example.com",
  "password": "secret123",
  "language": "ENGLISH"
}
```

### With Email Verification (Default)

1. User submits registration
2. User account created with `emailVerified=false`
3. Verification email sent with token link
4. Response includes masked email and message

```json
{
  "message": "Registration successful. Please check your email to verify your account.",
  "email": "j***@example.com"
}
```

5. User clicks verification link
6. Token validated, `emailVerified` set to true
7. User can now log in

### Without Email Verification

When `application.email.verification.enabled=false`:
1. User submits registration
2. User created with `emailVerified=true`
3. JWT token returned immediately
4. Welcome email sent

### Closed Beta (Invite Code Required)

When `application.closed-beta=true`:
1. Registration requires `inviteCode` field
2. Code validated against `InviteCode` entity
3. Code use count incremented
4. Registration proceeds normally

## Invite Codes

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/model/InviteCode.java`

| Field | Type | Description |
|-------|------|-------------|
| `code` | String(50) | Unique code (uppercase) |
| `description` | String(255) | Internal description |
| `maxUses` | Integer | Maximum uses (null = unlimited) |
| `useCount` | int | Current usage count |
| `enabled` | boolean | Code enabled status |
| `expiresAt` | Instant | Expiration date (optional) |

A code is usable when:
- `enabled = true`
- Not expired (`expiresAt` not passed)
- Under max uses (`useCount < maxUses` or `maxUses` is null)

## Authentication

### Login

```
POST /auth/login
{
  "username": "john",
  "password": "secret123"
}
```

Response:
```json
{
  "token": "eyJhbG...",
  "user": {
    "id": "uuid",
    "username": "john",
    "email": "john@example.com",
    "role": "USER"
  }
}
```

### JWT Token

- Generated by `JwtService.generateToken()`
- Contains username as subject
- Stored in `localStorage` on frontend
- Sent as `Authorization: Bearer <token>` header

### Email Verification

**File:** `backend/src/main/java/be/transcode/morningdeck/server/core/service/EmailVerificationService.java`

```
GET /auth/verify-email?token=<token>
```

- Token is a random UUID
- Expires after configured duration
- Single use (deleted after verification)
- Resend available via:

```
POST /auth/resend-verification
{
  "email": "john@example.com"
}
```

## Admin Management

Admins can manage users via `/admin/**` endpoints:

| Endpoint | Purpose |
|----------|---------|
| `GET /admin/users` | List users with pagination |
| `GET /admin/users/{id}` | Get user details |
| `PATCH /admin/users/{id}/enabled` | Enable/disable account |
| `PATCH /admin/users/{id}/email` | Change user email |
| `PATCH /admin/users/{id}/password` | Reset password |
| `PATCH /admin/users/{id}/subscription` | Change subscription plan |
| `PATCH /admin/users/{id}/credits` | Adjust credit balance |
| `POST /admin/users/{id}/verify-email` | Manually verify email |

## Configuration

```properties
# Closed beta mode (requires invite codes)
application.closed-beta=true

# Email verification
application.email.verification.enabled=true
application.email.verification.token-expiry-hours=24
```

## Key Files Reference

| Component | File Path |
|-----------|-----------|
| User Entity | `backend/.../core/model/User.java` |
| Subscription Entity | `backend/.../core/model/Subscription.java` |
| Role Enum | `backend/.../core/model/Role.java` |
| InviteCode Entity | `backend/.../core/model/InviteCode.java` |
| AuthenticationService | `backend/.../core/service/AuthenticationService.java` |
| UserService | `backend/.../core/service/UserService.java` |
| EmailVerificationService | `backend/.../core/service/EmailVerificationService.java` |
| InviteCodeService | `backend/.../core/service/InviteCodeService.java` |
| JwtService | `backend/.../core/service/JwtService.java` |
| AuthController | `backend/.../core/controller/AuthController.java` |
| AdminController | `backend/.../core/controller/AdminController.java` |

## Related Documentation

- [Credits](./credits.md) - Credit system details
- [Security](../architecture/security.md) - Authentication implementation
- [Email Infrastructure](../architecture/email-infrastructure.md) - Verification emails
